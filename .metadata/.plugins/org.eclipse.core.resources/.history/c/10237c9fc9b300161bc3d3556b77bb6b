package nameservice;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.UnknownHostException;
import java.util.HashMap;

import aufgabe3.Client;
import mware_lib.Connection;
import mware_lib.NameService;
import mware_lib.RawObject;

public class NameServiceImpl{

	private static HashMap<String, RawObject> nameMap = new HashMap<String,RawObject>();

	@Override
	public void rebind(Object servant, String name) {
		RawObject rawObj = new RawObject(0,0,servant);
		
		nameMap.put(name, rawObj);
	}

	@Override
	public Object resolve(String name) {
		return nameMap.get(name);
	}

	public static void main(String[] args) throws IOException, ClassNotFoundException {
		NameServiceImpl nameServ = new NameServiceImpl();
		ServerSocket mySvrSocket;
		ObjectOutputStream objOut; // rebind
		ObjectInputStream objIn; // resolve

		mySvrSocket = new ServerSocket(8811);

		while (true) {
			Socket mySock = mySvrSocket.accept();

			objIn = new ObjectInputStream(mySock.getInputStream());
			objOut = new ObjectOutputStream(mySock.getOutputStream());
			
			String req = (String) objIn.readObject();
			System.out.println(req);

			if (req.equals("resolve")) {
				System.out.println("Got resolve request");

				String name = (String) objIn.readObject();
				
				System.out.println("Got resolve-Request for : " + name );
				
				Object obj = nameServ.resolve(name);
				System.out.println(obj.toString());
				
				objOut.writeObject(obj);
				objOut.flush();

				System.out.println("Finished resolve request");
				
			} else if (req.equals("rebind")) {
				System.out.println("Got rebind request");
				
				Object servant = (Object) objIn.readObject();
				String name = (String) objIn.readObject();

				System.out.println("Add Object: " + servant.toString() + " with name : " + name + " to nameMap!");

				nameServ.rebind(servant, name);

				System.out.println("Finished rebind request");
			} else {
				System.out.println(req);
			}

			objIn.close();
			objOut.close();
			mySock.close();
		}
	}
}
